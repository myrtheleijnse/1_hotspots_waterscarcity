### Execution ###
df_SPEI <- ncdf_to_df_mean("Indicators/SPEI/spei12month.nc", shp_list, "SPEI", "index", 1)
for (i in 2:length(shp_list)){
df <- ncdf_to_df_mean("Indicators/SPEI/spei12month.nc", shp_list, "SPEI", "index", i)
df_SPEI <- rbind(df_SPEI, df)
}
rownames(df_SPEI) <- seq(1,nrow(df_SPEI),1)
class(df_SPEI$year)
### Write csv ###
write.csv(df_SPEI, "Indicators/Indicator_tables/CRU_SPEI_1960_2019.csv", row.names=F)
class(df_SPEI$year)
spaghetti_plot(df_SPEI,
"SPEI",
"Zonal mean SPEI per hotspot",
1960, 2019)
class(df_SPEI$year)
df_SPEI <- read.csv("Indicators/Indicator_tables/CRU_SPEI_1960_2019.csv")
class(df_SPEI$year)
spaghetti_plot <- function(df, ylab_abs, title_abs, startyear, endyear) {
ggplot(df, aes(year, value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(hotspot == "California") +
scale_color_viridis_d(option = "H") +
#scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12)
}
spaghetti_plot(df_SPEI,
"SPEI",
"Zonal mean SPEI per hotspot",
1960, 2019)
spaghetti_plot <- function(df, ylab_abs, title_abs, startyear, endyear) {
ggplot(df, aes(year, value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(hotspot == "California") +
scale_color_viridis_d(option = "H") +
scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12)
}
spaghetti_plot(df_SPEI,
"SPEI",
"Zonal mean SPEI per hotspot",
1960, 2019)
warnings()
spaghetti_plot <- function(df, ylab_abs, title_abs, startyear, endyear) {
ggplot(df, aes(year, value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(hotspot == "California") +
scale_color_viridis_d(option = "H") +
scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12)
}
spaghetti_plot(df_SPEI,
"SPEI",
"Zonal mean SPEI per hotspot",
1960, 2019)
spaghetti_plot <- function(df, ylab_abs, title_abs, startyear, endyear) {
ggplot(df, aes(as.numeric(year), value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(hotspot == "California") +
scale_color_viridis_d(option = "H") +
scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12)
}
spaghetti_plot(df_SPEI,
"SPEI",
"Zonal mean SPEI per hotspot",
1960, 2019)
spaghetti_plot <- function(df, ylab_abs, title_abs, startyear, endyear) {
ggplot(df, aes(year, value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(hotspot == "California") +
scale_color_viridis_d(option = "H") +
scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12)
}
spaghetti_plot <- function(df, ylab_abs, title_abs, startyear, endyear) {
ggplot(df, aes(year, value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(hotspot == "California") +
scale_color_viridis_d(option = "H") +
#scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12)
}
spaghetti_plot(df_SPEI,
"SPEI",
"Zonal mean SPEI per hotspot",
1960, 2019)
### Reading Data ###
# shapefiles
setwd("E:/1_waterscarcity_hotspots/Data")
ff <- list.files("Water_provinces/Hotspot_Shapefiles/", pattern="\\.shp$", full.names=T)
shp_list <- lapply(ff, shapefile)
hotspots <- c("Irrawaddy", "California", "ChaoPhraya", "Chile", "China", "Euphrates", "Ganges", "Indus", "Japan", "Java", "Jordan",
"Mekong", "Mexico", "MurrayDarling", "Nile", "Rhine", "Spain", "Sudan", "USHighPlains")
names(shp_list) = hotspots
getwd
getwd()
ncinput = "cru_ts4.06.1951.1960.pre.dat.nc"
b <- brick(ncinput)
ncinput = "Indicators/Precipitation/cru_ts4.06.1951.1960.pre.dat.nc"
b <- brick(ncinput)
varname = "pre"
b <- brick(ncinput, varname = varname)
plot(b)
nlayers(b)
for (i in seq(1,120, 12)) {
print(i)
}
plot(clip[1:12])
plot(clip[[1:12]])
plot(clip[[1]])
shp = shp_list
shpcount = 2
clip <- mask(crop(b, extent(shp[[shpcount]])), shp[[shpcount]])
plot(clip[1:12])
plot(clip[[1:12]])
plot(calc(clip[1:12], sum))
plot(calc(clip[[1:12]], sum))
yearly_clip <- calc(clip[[1:+12]], sum)
for (i in seq(13,120, 12)) {
raster <- calc(clip[[i:i+12]], sum)
yearly_clip <- brick(yearly_clip, raster)
}
for (i in seq(13,120, 12)) {
raster <- calc(clip[[i:i+12]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
b <- brick(ncinput, varname = varname)
clip <- mask(crop(b, extent(shp[[shpcount]])), shp[[shpcount]])
yearly_clip <- calc(clip[[1:+12]], sum)
for (i in seq(13,120, 12)) {
raster <- calc(clip[[i:i+12]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
for (i in seq(13,120, 12)) {
print(i)
raster <- calc(clip[[i:i+12]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
for (i in seq(13,119, 12)) {
print(i)
raster <- calc(clip[[i:i+12]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
nlayers(clip)
raster<- calc(clip[[13:(13+12)]], sum)
stack <- brick(yearly_clip, raster)
stack <- stack(yearly_clip, raster)
for (i in seq(13,120, 12)) {
print(i)
raster <- calc(clip[[i:(i+12)]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
i = 13
yearly_clip <- calc(clip[[1:12]], sum)
print(i)
raster <- calc(clip[[i:(i+12)]], sum)
yearly_clip <- stack(yearly_clip, raster)
plot(yearly_clip)
seq(13,120, 12)
109+12
120/10
ncinput
ncinput = "Indicators/Precipitation/cru_ts4.06.1961.1970.pre.dat.nc"
b <- brick(ncinput, varname = varname)
clip <- mask(crop(b, extent(shp[[shpcount]])), shp[[shpcount]])
yearly_clip <- calc(clip[[1:12]], sum)
plot(yearly_clip)
for (i in seq(13,120, 12)) {
print(i)
raster <- calc(clip[[i:(i+11)]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
plot(yearly_clip)
as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y")
)
unique(as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y")))
ncinput
### Reading Data ###
filelist <- list.files(path = "Indicators/Precipitation/", pattern = "\\.nc$", full.names=T, recursive = F)
nc_open("Indicators/Precipitation/cru_ts4.06.1961.1970.pre.dat.nc")
### Execution ###
list_df_prcp <- lapply(filelist, function(x){ncdf_to_df_sum(x, shp_list, "pre", "Precipitation", "mm", 1)})
### Functions ###
ncdf_to_df_sum <- function(ncinput, shp, varname, variable, unit, shpcount){
b <- brick(ncinput, varname = varname)
clip <- mask(crop(b, extent(shp[[shpcount]])), shp[[shpcount]])
yearly_clip <- calc(clip[[1:12]], sum)
for (i in seq(13,120, 12)) {
print(i)
raster <- calc(clip[[i:(i+11)]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
df <- data.frame(value = cellStats(clip, "sum"),
year = unique(as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y"))),
variable = variable,
unit = unit,
hotspot = names(shp[shpcount]),
value.ref = cellStats(clip, "sum")) #initialize
return (df)
}
### Execution ###
list_df_prcp <- lapply(filelist, function(x){ncdf_to_df_sum(x, shp_list, "pre", "Precipitation", "mm", 1)})
filelist[[1]]
list_df_prcp[[1]]
df <- data.frame(value = cellStats(yearly_clip, "sum"),
year = unique(as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y"))),
variable = variable,
unit = unit,
hotspot = names(shp[shpcount]),
value.ref = cellStats(yearly_clip, "sum")) #initialize
variable = " Precipitation"
unit = " mm"
### Functions ###
ncdf_to_df_sum <- function(ncinput, shp, varname, variable, unit, shpcount){
b <- brick(ncinput, varname = varname)
clip <- mask(crop(b, extent(shp[[shpcount]])), shp[[shpcount]])
yearly_clip <- calc(clip[[1:12]], sum)
for (i in seq(13,120, 12)) {
print(i)
raster <- calc(clip[[i:(i+11)]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
df <- data.frame(value = cellStats(yearly_clip, "sum"),
year = unique(as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y"))),
variable = variable,
unit = unit,
hotspot = names(shp[shpcount]),
value.ref = cellStats(yearly_clip, "sum")) #initialize
return (df)
}
df <- data.frame(value = cellStats(yearly_clip, "sum"),
year = unique(as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y"))),
variable = variable,
unit = unit,
hotspot = names(shp[shpcount]),
value.ref = cellStats(yearly_clip, "sum")) #initialize
View(df)
for (i in 2:length(shp_list)){
list_df_prcp_shp <- lapply(filelist, function(x){ncdf_to_df_sum(x, shp_list, "pre", "Precipitation", "mm", i)} )
list_df_prcp <- append(list_df_prcp, list_df_prcp_shp)
print(i)
}
list_df_prcp
df_prcp <- do.call("rbind", list_df_prcp)
View(df_prcp)
rownames(df_prcp) <- seq(1,nrow(df_prcp),1)
df_prcp <- df_prcp[df_prcp$year >= 1960,]
### Execution ###
list_df_prcp <- lapply(filelist, function(x){ncdf_to_df_sum(x, shp_list, "pre", "Precipitation", "mm", 1)})
for (i in 2:length(shp_list)){
list_df_prcp_shp <- lapply(filelist, function(x){ncdf_to_df_sum(x, shp_list, "pre", "Precipitation", "mm", i)} )
list_df_prcp <- append(list_df_prcp, list_df_prcp_shp)
print(i)
}
rownames(df_prcp) <- seq(1,nrow(df_prcp),1)
df_prcp <- do.call("rbind", list_df_prcp)
rownames(df_prcp) <- seq(1,nrow(df_prcp),1)
df_prcp <- df_prcp[df_prcp$year >= 1960,]
length(unique(as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y"))))
length(shp_list)
for (j in seq(1,nrow(df_prcp),70)){
for (i in j:(j+(length(shp_list)))){
df_prcp$value.ref[i] <- df_prcp$value[i]/df_prcp$value[j]
}
}
rownames(df_prcp) <- seq(1,nrow(df_prcp),1)
df_prcp <- df_prcp[df_prcp$year >= 1960 & df_prcp$year <= 2019,]
rownames(df_prcp) <- seq(1,nrow(df_prcp),1)
for (j in seq(1,nrow(df_prcp),70)){
for (i in j:(j+(length(shp_list)))){
df_prcp$value.ref[i] <- df_prcp$value[i]/df_prcp$value[j]
}
}
for (j in seq(1,nrow(df_prcp),60)){
for (i in j:(j+(length(shp_list)))){
df_prcp$value.ref[i] <- df_prcp$value[i]/df_prcp$value[j]
}
}
### Write CSV ###
write.csv(df_prcp, "Indicators/Indicator_tables/CRU_prcp_1960_2019.csv", row.names=F)
### Functions ###
relative_spaghetti_plot <- function(df, ylab_abs, title_abs, ylab_rel, title_rel, startyear, endyear) {
grid.arrange(
ggplot(df, aes(year, value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(max(value)>-2) +
scale_color_viridis_d(option = "H") +
scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12),
ggplot(df, aes(year, value.ref, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(max(value)>-2) +
scale_color_viridis_d(option = "H") +
scale_x_discrete(breaks=seq(2001, 2010, 2)) +
ylab(ylab_rel) +
ggtitle(paste0(title_rel, startyear)) +
theme_ipsum(axis_title_size = 12),
nrow = 1
)
}
spaghetti_plot <- function(df, ylab_abs, title_abs, startyear, endyear) {
ggplot(df, aes(year, value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(hotspot == "California") +
scale_color_viridis_d(option = "H") +
#scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12)
}
### Reading Data ###
# shapefiles
setwd("E:/1_waterscarcity_hotspots/Data")
ff <- list.files("Water_provinces/Hotspot_Shapefiles/", pattern="\\.shp$", full.names=T)
shp_list <- lapply(ff, shapefile)
hotspots <- c("Irrawaddy", "California", "ChaoPhraya", "Chile", "China", "Euphrates", "Ganges", "Indus", "Japan", "Java", "Jordan",
"Mekong", "Mexico", "MurrayDarling", "Nile", "Rhine", "Spain", "Sudan", "USHighPlains")
names(shp_list) = hotspots
### Functions ###
ncdf_to_df_sum <- function(ncinput, shp, varname, variable, unit, shpcount){
b <- brick(ncinput, varname = varname)
clip <- mask(crop(b, extent(shp[[shpcount]])), shp[[shpcount]])
yearly_clip <- calc(clip[[1:12]], sum)
for (i in seq(13,120, 12)) {
raster <- calc(clip[[i:(i+11)]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
df <- data.frame(value = cellStats(yearly_clip, "sum"),
year = unique(as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y"))),
variable = variable,
unit = unit,
hotspot = names(shp[shpcount]),
value.ref = cellStats(yearly_clip, "sum")) #initialize
return (df)
}
### Reading Data ###
filelist <- list.files(path = "Indicators/Precipitation/", pattern = "\\.nc$", full.names=T, recursive = F)
### Execution ###
list_df_prcp <- lapply(filelist, function(x){ncdf_to_df_sum(x, shp_list, "pre", "Precipitation", "mm", 1)})
for (i in 2:length(shp_list)){
list_df_prcp_shp <- lapply(filelist, function(x){ncdf_to_df_sum(x, shp_list, "pre", "Precipitation", "mm", i)} )
list_df_prcp <- append(list_df_prcp, list_df_prcp_shp)
print(i)
}
df_prcp <- do.call("rbind", list_df_prcp)
df_prcp <- df_prcp[df_prcp$year >= 1960 & df_prcp$year <= 2019,]
rownames(df_prcp) <- seq(1,nrow(df_prcp),1)
for (j in seq(1,nrow(df_prcp),60)){
for (i in j:(j+(length(shp_list)))){
df_prcp$value.ref[i] <- df_prcp$value[i]/df_prcp$value[j]
}
}
View(df_prcp)
ncinput = "Indicators/Precipitation/cru_ts4.06.2011.2020.pre.dat.nc"
shp = shp_list
varname = "pre"
variable = "Precipitation"
unit = " mm"
shpcount = 2
b <- brick(ncinput, varname = varname)
clip <- mask(crop(b, extent(shp[[shpcount]])), shp[[shpcount]])
yearly_clip <- calc(clip[[1:12]], sum)
for (i in seq(13,120, 12)) {
raster <- calc(clip[[i:(i+11)]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
plot(yearly_clip)
### Functions ###
ncdf_to_df_mean <- function(ncinput, shp, varname, variable, unit, shpcount){
b <- brick(ncinput, varname = varname)
clip <- mask(crop(b, extent(shp[[shpcount]])), shp[[shpcount]])
yearly_clip <- calc(clip[[1:12]], sum)
for (i in seq(13,120, 12)) {
raster <- calc(clip[[i:(i+11)]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
df <- data.frame(value = cellStats(yearly_clip, "mean"),
year = unique(as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y"))),
variable = variable,
unit = unit,
hotspot = names(shp[shpcount]),
value.ref = cellStats(yearly_clip, "mean")) #initialize
return (df)
}
### Functions ###
ncdf_to_df_mean <- function(ncinput, shp, varname, variable, unit, shpcount){
b <- brick(ncinput, varname = varname)
clip <- mask(crop(b, extent(shp[[shpcount]])), shp[[shpcount]])
yearly_clip <- calc(clip[[1:12]], sum)
for (i in seq(13,120, 12)) {
raster <- calc(clip[[i:(i+11)]], sum)
yearly_clip <- stack(yearly_clip, raster)
}
df <- data.frame(value = cellStats(yearly_clip, "mean"),
year = unique(as.numeric(format(strptime(getZ(clip), "%Y-%m-%d"), format = "%Y"))),
variable = variable,
unit = unit,
hotspot = names(shp[shpcount]),
value.ref = cellStats(yearly_clip, "mean")) #initialize
return (df)
}
### Execution ###
list_df_prcp <- lapply(filelist, function(x){ncdf_to_df_mean(x, shp_list, "pre", "Precipitation", "mm/y", 1)})
for (i in 2:length(shp_list)){
list_df_prcp_shp <- lapply(filelist, function(x){ncdf_to_df_mean(x, shp_list, "pre", "Precipitation", "mm/y", i)} )
list_df_prcp <- append(list_df_prcp, list_df_prcp_shp)
print(i)
}
df_prcp <- do.call("rbind", list_df_prcp)
df_prcp <- df_prcp[df_prcp$year >= 1960 & df_prcp$year <= 2019,]
rownames(df_prcp) <- seq(1,nrow(df_prcp),1)
for (j in seq(1,nrow(df_prcp),60)){
for (i in j:(j+(length(shp_list)))){
df_prcp$value.ref[i] <- df_prcp$value[i]/df_prcp$value[j]
}
}
seq(1,nrow(df_prcp),60)
for (j in seq(1,nrow(df_prcp),60)){
for (i in j:(j+59)){
df_prcp$value.ref[i] <- df_prcp$value[i]/df_prcp$value[j]
}
}
### Write CSV ###
write.csv(df_prcp, "Indicators/Indicator_tables/CRU_prcp_1960_2019.csv", row.names=F)
df_prcp <- read.csv("Indicators/Indicator_tables/CRU_prcp_1960_2019.csv")
relative_spaghetti_plot(df_prcp,
"Precipitation (mm/y)",
"Annual mean precipitation per hotspot",
"Relative precipitation",
"Annual mean precipitation per hotspot relative to ",
1960, 2019)
### Libraries ###
library(sf)
library(viridis)
library(hrbrthemes)
library(gghighlight)
library(raster)
library(gridExtra)
library(maptools)
### Functions ###
relative_spaghetti_plot <- function(df, ylab_abs, title_abs, ylab_rel, title_rel, startyear, endyear) {
grid.arrange(
ggplot(df, aes(year, value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(max(value)>-2) +
scale_color_viridis_d(option = "H") +
scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12),
ggplot(df, aes(year, value.ref, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(max(value)>-2) +
scale_color_viridis_d(option = "H") +
scale_x_discrete(breaks=seq(2001, 2010, 2)) +
ylab(ylab_rel) +
ggtitle(paste0(title_rel, startyear)) +
theme_ipsum(axis_title_size = 12),
nrow = 1
)
}
spaghetti_plot <- function(df, ylab_abs, title_abs, startyear, endyear) {
ggplot(df, aes(year, value, group=hotspot, colour = hotspot)) +
geom_line(lwd=1.5) +
gghighlight(hotspot == "California") +
scale_color_viridis_d(option = "H") +
#scale_x_discrete(breaks=seq(startyear, endyear, 2)) +
ylab(ylab_abs) +
ggtitle(title_abs) +
theme_ipsum(axis_title_size = 12)
}
### Reading Data ###
# shapefiles
setwd("E:/1_waterscarcity_hotspots/Data")
df_prcp <- read.csv("Indicators/Indicator_tables/CRU_prcp_1960_2019.csv")
### Reading Data ###
# shapefiles
setwd("E:/1_waterscarcity_hotspots/Data")
### Reading Data ###
# shapefiles
setwd("E:/1_waterscarcity_hotspots/data")
setwd("E:/")
### Reading Data ###
# shapefiles
setwd("E:/1_waterscarcity_hotspots/data")
### Reading Data ###
# shapefiles
setwd("E:/1_waterscarcity_hotspots")
### Reading Data ###
# shapefiles
setwd("E:\1_waterscarcity_hotspots")
### Reading Data ###
# shapefiles
setwd("~/1_waterscarcity_hotspots")
### Reading Data ###
# shapefiles
setwd("E:/1_waterscarcity_hotspots/Data")
